<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Styled Page Structure</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <!-- 顶部固定的标题 -->
    <header class="fixed-header">
        <h1>Web Name</h1>
    </header>

    <!-- 主内容部分 -->
    <main class="container">
        <div class="content-with-ad">
            <div class="sub-container">
                <!-- 第一个大模块 -->
                <section class="large-module">
                    <h3>Discover Your Career Path with Webname</h3>
                    <p class="custom-paragraph">Are you contemplating your next career move or feeling unsure about your future? 
                        Perhaps you have a diverse skill set and are curious about the roles and fields you could excel in, 
                        or maybe you have a dream job and want to understand how to achieve it. Our tool is here to guide you.</p>
                    <p class="custom-paragraph">We’ve compiled a wealth of real-life career journeys and related skills to inspire and inform your career exploration. 
                        By leveraging insights from others’ experiences, you can uncover potential career paths and new areas of opportunity.</p>
                </section>
        
                <!-- 第二个大模块 -->
                <section class="large-module">
                    <form action="/submit" method="post">
                        <div class="form-group">
                            <h3>Enter your job title and/or skills to discover related professions and potential career paths.</h3>
                        </div>
                        <div class="form-group">
                            <label for="jobTitle">Job Title:</label>
                            <textarea id="jobTitle" name="jobTitle" rows="1" placeholder="e.g., Marketing Manager">{{job_title}}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="skills">Skills (separate with ","):</label>
                            <textarea id="skills" name="skills" rows="1" placeholder="e.g., Strategic Planning, Budgeting, SEO, ...">{{skills}}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="coreNodesCnt">Number of Core Matches:</label>
                            <textarea id="coreNodesCnt" name="coreNodesCnt" rows="1" placeholder="e.g., 5">{{coreNodesCnt}}</textarea>
                        </div>
                        <button id="submitBtn">Submit</button>
                    </form>
                </section>
            </div>
        
            <!-- 侧边广告区域 -->
            <aside class="side-ad">
                <!-- 将来添加广告内容 -->
                <p>Advertisement</p>
            </aside>
        </div>

        <!-- 第三个大模块 -->
        <section class="large-module">
            <div class="notation-block">
                <div class="color-info">
                    <span class="color-circle" style="background-color: #9ddddd;"></span>  <!-- 颜色圆圈 -->
                    <span class="color-description">Similar Job Title</span>  <!-- 颜色解释文字 -->
                </div>
                <div class="color-info">
                    <span class="color-circle" style="background-color: #ceeeee;"></span>  <!-- 颜色圆圈 -->
                    <span class="color-description">Potential Path</span>  <!-- 颜色解释文字 -->
                </div>
            </div>

            <!-- <div id="controls">
                <label for="coreSlider">Number of Core Nodes: </label>
                <input type="range" id="coreSlider" min="1" max="10" value="2" />
            </div> -->

            <div class="graph-container">
                <div id="graph-section">
                    <!-- 如果有 error_message 则显示错误信息，否则显示图表 -->
                    {% if error_message %}
                        <div class="error">{{ error_message }}</div>
                    {% elif links and nodes and skillsData %}
                        <!-- Graph will be inserted here -->

                        <script type="text/javascript">
                            // D3.js visualization code here
                            // 获取 graph-section 的长宽
                            const graphSection = document.getElementById('graph-section');
                            const width = graphSection.clientWidth;
                            const height = graphSection.clientHeight;

                            const svg = d3.select("#graph-section").append("svg")
                                .attr("width", "100%")
                                .attr("height", "100%")
                                .attr("viewBox", `0 0 ${width} ${height}`)  // 设置 viewBox，svg 将自适应缩放
                                .attr("preserveAspectRatio", "xMidYMid meet");  // 保持纵横比居中显示
                                // .attr("width", width)
                                // .attr("height", height);

                            var skillsData = {{ skillsData | tojson | safe }};
                            var nodes = {{ nodes | tojson | safe }};
                            var links = {{ links | tojson | safe }};
                            
                            // console.log(skillsData);
                            // console.log(nodes);
                            // console.log(links);

                            // 添加箭头标记
                            svg.append("defs").append("marker")
                                .attr("id", "arrow")
                                .attr("viewBox", "0 -5 10 10")
                                .attr("refX", 30)  // 让箭头的位置稍微离开圆圈一点
                                .attr("refY", 0)
                                .attr("markerWidth", 6)
                                .attr("markerHeight", 6)
                                .attr("orient", "auto")
                                .append("path")
                                .attr("d", "M0,-5L10,0L0,5")
                                .attr("fill", "#aaa");

                            // Initialize force simulation
                            const simulation = d3.forceSimulation(nodes)
                                .force("link", d3.forceLink(links).id(d => d.id).distance(100))     // 连线长度
                                .force("charge", d3.forceManyBody().strength(-80))     // 节点之间的排斥力
                                .force("center", d3.forceCenter(width / 2, height / 2))
                                .force("collision", d3.forceCollide().radius(d => d.similarity * 25));

                            const link = svg.append("g")
                                .attr("stroke", "#aaa")
                                .selectAll("line")
                                .data(links)
                                .enter().append("line")
                                .attr("class", "link")
                                .attr("marker-end", "url(#arrow)");  // 为每条线添加箭头

                            const node = svg.append("g")
                                .attr("stroke", "#fff")
                                .attr("stroke-width", 1.5)
                                .selectAll("circle")
                                .data(nodes)
                                .enter().append("circle")
                                .attr("class", "node")
                                .attr("r", d => d.similarity * 40)
                                .attr("fill", d => d.group === 'core' ? "#9ddddd" : "#ceeeee")
                                .attr("opacity", 0.3)  // 初始状态为半透明
                                .call(drag(simulation));

                            const text = svg.append("g")
                                .selectAll("text")
                                .data(nodes)
                                .enter().append("text")
                                .attr("class", d => d.group === 'core' ? "core-text" : "outer-text")
                                .attr("id", d => d.id)  // 添加唯一ID，方便选择
                                .attr("dy", ".35em")
                                .attr("text-anchor", "middle")
                                .attr("fill", "#000000")  // 默认文字颜色灰色
                                .attr("opacity", 0.3)  // 设置文字透明度
                                .text(d => d.id)
                                .call(drag(simulation));

                            // 保存当前高亮的节点和文字
                            let highlightedNode = null;
                            let highlightedText = null;
                            
                            node.on("click", function(event, d) {
                                // 如果存在已高亮的节点，重置样式
                                if (highlightedNode) {
                                    d3.select(highlightedNode)
                                        .attr("fill", d => d.group === 'core' ? "#9ddddd" : "#ceeeee")
                                        .attr("opacity", 0.3);  // 恢复透明度
                                    
                                    d3.select(highlightedText)
                                        .attr("fill", "#000000")  // 恢复文字颜色
                                        .attr("opacity", 0.3);  // 恢复文字透明度
                                }

                                // 更新高亮的节点和文字的引用
                                highlightedNode = this;
                                highlightedText = document.getElementById(d.id);

                                // 高亮当前点击的节点和对应的文字
                                d3.select(highlightedNode)
                                    .attr("fill", d.group === 'core' ? "#9ddddd" : "#ceeeee")
                                    .attr("opacity", 1);  // 高亮节点

                                d3.select(highlightedText)  // 选择对应的文字
                                    .attr("fill", "#000000")
                                    .attr("opacity", 1);  // 高亮文字

                                // 展示相关技能信息
                                showSkills(d.id);
                            });

                            simulation.nodes(nodes).on("tick", () => {
                                // 限制节点位置在graph-section内，不要超出skills-section的范围
                                const minX = 0;
                                const maxX = width * 0.97;  // Graph section占据70%的宽度
                                const minY = 0;
                                const maxY = height * 0.97;

                                link.attr("x1", d => Math.max(minX, Math.min(maxX, d.source.x)))
                                    .attr("y1", d => Math.max(minY, Math.min(maxY, d.source.y)))
                                    .attr("x2", d => Math.max(minX, Math.min(maxX, d.target.x)))
                                    .attr("y2", d => Math.max(minY, Math.min(maxY, d.target.y)));

                                node.attr("cx", d => d.x = Math.max(minX, Math.min(maxX, d.x)))
                                    .attr("cy", d => d.y = Math.max(minY, Math.min(maxY, d.y)));

                                text.attr("x", d => d.x = Math.max(minX, Math.min(maxX, d.x)))
                                    .attr("y", d => d.y = Math.max(minY, Math.min(maxY, d.y)));
                            });

                            simulation.force("link").links(links);

                            // Add window resize listener to adjust the graph dynamically
                            window.addEventListener('resize', () => {
                                const newWidth = document.getElementById('graph-section').clientWidth;
                                const newHeight = document.getElementById('graph-section').clientHeight;

                                // Update the svg size
                                svg.attr("width", newWidth)
                                .attr("height", newHeight);

                                // Recenter the force layout
                                simulation.force("center", d3.forceCenter(newWidth / 2, newHeight / 2))
                                    .alpha(1).restart();  // Restart simulation to reposition nodes and links

                                // Ensure nodes stay within bounds of the new size
                                simulation.nodes(nodes).on("tick", () => {
                                    const minX = 0, maxX = newWidth * 0.97, minY = 0, maxY = newHeight * 0.97;

                                    link.attr("x1", d => Math.max(minX, Math.min(maxX, d.source.x)))
                                        .attr("y1", d => Math.max(minY, Math.min(maxY, d.source.y)))
                                        .attr("x2", d => Math.max(minX, Math.min(maxX, d.target.x)))
                                        .attr("y2", d => Math.max(minY, Math.min(maxY, d.target.y)));

                                    node.attr("cx", d => d.x = Math.max(minX, Math.min(maxX, d.x)))
                                        .attr("cy", d => d.y = Math.max(minY, Math.min(maxY, d.y)));

                                    text.attr("x", d => d.x = Math.max(minX, Math.min(maxX, d.x)))
                                        .attr("y", d => d.y = Math.max(minY, Math.min(maxY, d.y)));
                                });

                                // Keep the nodes' radius and text size fixed
                                node.attr("r", d => d.similarity * 30);  // Reapply the fixed radius
                                text.style("font-size", "12px");  // Fix the font size, adjust as needed
                            });

                            // Bar chart for skills
                            function showSkills(role) {
                                // 获取并处理数据
                                const data = Object.entries(skillsData[role] || []).map(([skill, importance]) => {
                                    return { skill, importance };
                                });

                                // 按 importance 从大到小排序
                                data.sort((a, b) => b.importance - a.importance);

                                // 设置 x 轴的比例尺
                                const x = d3.scaleLinear()
                                    .domain([0, d3.max(data, d => d.importance)])  // 动态调整最大值
                                    .range([0, 200]);

                                const barHeight = 20;

                                // 选择 SVG 元素并清除之前的图表
                                const svg = d3.select("#skillsChart");
                                svg.selectAll("*").remove();

                                // 绘制条形图
                                svg.selectAll("rect")
                                    .data(data)
                                    .enter().append("rect")
                                    .attr("width", d => x(d.importance))  // 动态调整宽度
                                    .attr("height", barHeight - 16)  // 每个条的高度
                                    .attr("x", 8)  // 控制水平位置
                                    .attr("y", (d, i) => i * barHeight + 18)  // 控制条形的垂直位置
                                    .attr("rx", 2)  // 设置条形的圆角半径
                                    .attr("ry", 2)  // 设置条形的圆角半径
                                    .attr("fill", "#087e7edd")  // 条形的颜色  1a8c8c
                                    .attr("stroke", "#333")  // 设置条形边框颜色
                                    .attr("stroke-width", 0);  // 设置边框的粗细

                                // 绘制文本
                                svg.selectAll("text")
                                    .data(data)
                                    .enter().append("text")
                                    .attr("x", 10)  // 控制文本的水平位置
                                    .attr("y", (d, i) => i * barHeight + (barHeight / 2))  // 控制文本的垂直位置
                                    .attr("dy", ".35em")  // 控制文本的基线对齐
                                    .style("font-size", "10px")  // 字体大小
                                    .style("font-family", "Arial, sans-serif")  // 字体
                                    // .style("font-weight", "bold")  // 字体加粗
                                    .style("fill", "#333")  // 文字颜色
                                    .text(d => d.skill);
                            }

                            // Slider for core node count
                            // d3.select("#coreSlider").on("input", function() {
                            //     const coreCount = +this.value;
                            //     console.log("Core nodes to display:", coreCount);
                            //     // Logic to adjust displayed core nodes will go here.
                            // });

                            function drag(simulation) {
                                function dragstarted(event) {
                                    if (!event.active) simulation.alphaTarget(0.3).restart();
                                    event.subject.fx = event.subject.x;
                                    event.subject.fy = event.subject.y;
                                }

                                function dragged(event) {
                                    event.subject.fx = event.x;
                                    event.subject.fy = event.y;
                                }

                                function dragended(event) {
                                    if (!event.active) simulation.alphaTarget(0);
                                    event.subject.fx = null;
                                    event.subject.fy = null;
                                }

                                return d3.drag()
                                    .on("start", dragstarted)
                                    .on("drag", dragged)
                                    .on("end", dragended);
                            }

                        </script>
                    {% endif %}
                </div>
                <div id="skills-section">
                    <h3>Top Skills - click circles to show</h>
                    <svg id="skillsChart" width="400" height="600"></svg>
                </div>
            </div>
        </section>
        
        <!-- 横向广告区域 -->
        <aside class="bar-ad">
            <!-- 将来添加广告内容 -->
            <p>Advertisement</p>
        </aside>

        <div class="content-with-ad">
            <div class="sub-container">
                <!-- 第四个大模块 -->
                <section class="large-module">
                    <h3>More Matches</h3>
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Similar Roles</th>
                                <th>Potential Career Path</th>
                                <th>Skills</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>

                    <script>
                        // Sample table_data object (this should come from your server-side code or API)
                        var table_data = {{ table_data | default('{}') | tojson | safe }};
                    
                        // Function to populate the table with data
                        function populateTable(data) {
                            const tableBody = document.querySelector("#data-table tbody");
                            
                            // Get the number of rows
                            const numRows = data['Rank'].length;
                    
                            for (let i = 0; i < numRows; i++) {
                                const row = document.createElement("tr");
                                
                                // Append cells for each column
                                for (const key of ['Rank', 'Similar Roles', 'Potential Career Path', 'Skills']) {
                                    const cell = document.createElement("td");
                                    cell.textContent = data[key][i];  // Get the data for the current row and column
                                    row.appendChild(cell);
                                }
                                
                                tableBody.appendChild(row);
                            }
                        }
                    
                        // Populate the table when the page loads
                        populateTable(table_data);
                    </script>
                </section>
            </div>

            <!-- 侧边广告区域 -->
            <aside class="side-ad">
                <!-- 将来添加广告内容 -->
                <p>Advertisement</p>
            </aside>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 Example Company. All Rights Reserved.</p>
    </footer>

</body>
</html>